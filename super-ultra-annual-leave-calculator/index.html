<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>연차·미사용수당 파이썬 엔진 (Pyodide + 나이스 엑셀)</title>

  <!-- 공통 스타일 -->
  <link rel="stylesheet" href="/static/style.css" />

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  <!-- SheetJS: 엑셀 파싱 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    .field { display:flex; flex-direction:column; gap:4px; margin-bottom:8px; }
    .numeric { text-align:right; }
    .status { font-size:0.9rem; color:#555; margin-top:4px; }
    .danger { color:#c8352d; }
    .result-grid {
      display:flex; flex-direction:column; gap:6px; font-size:0.92rem;
    }
    .result-item {
      display:flex; align-items:baseline; gap:8px; flex-wrap:wrap;
    }
    .result-label { min-width:200px; font-weight:600; }
    .result-value {
      margin-left:auto; text-align:right; font-variant-numeric:tabular-nums;
    }
    .highlight { font-size:1.05rem; font-weight:700; }
    @media (max-width:640px){
      .result-label{min-width:140px;}
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="shell">
      <h1>연차·미사용수당 파이썬 엔진 (Pyodide + 나이스 엑셀)</h1>
      <p class="sub">
        <b>annual_engine.py</b> 안의 파이썬 로직을 <b>브라우저에서 그대로 실행</b>하면서,<br>
        나이스 <b>근무상황목록(.xlsx)</b>도 업로드해서 복무별 사용시간을 집계하는 데모입니다.
      </p>
    </div>
  </header>

  <main>
    <!-- 0. 나이스 엑셀 업로드 + 파이썬 집계 -->
    <section class="section">
      <h2>0. 나이스 근무상황목록(.xlsx) 업로드 분석 (Pyodide 사용)</h2>
      <p class="muted">
        나이스에서 내려받은 <b>근무상황목록</b> 엑셀을 올리면,<br>
        SheetJS로 엑셀을 읽고, Pyodide 안의 <code>summarize_nice_records()</code>로
        복무별 사용시간을 집계합니다.
      </p>

      <div class="card">
        <div class="grid two">
          <div class="field">
            <label for="niceFilePy">근무상황목록 엑셀 파일 (.xlsx)</label>
            <input type="file" id="niceFilePy" accept=".xlsx,.xls" />
          </div>
          <div class="field">
            <label for="hoursPerDayPy">1일 소정근로시간</label>
            <input id="hoursPerDayPy" type="number" step="0.5" value="8" class="numeric" />
          </div>
        </div>
        <p class="muted" style="font-size:0.85rem;">
          ※ “종별” 열과 “일수/기간” 열은 헤더 이름을 기준으로 자동 추정합니다.
          (필요하면 JS에서 후보 목록 수정)
        </p>
        <div class="row" style="margin-top:8px;">
          <button type="button" class="btn primary" id="btnAnalyzeNice" disabled>엑셀 업로드·집계</button>
          <button type="button" class="btn ghost" id="btnResetNice">초기화</button>
        </div>
        <div id="niceStatus" class="status" style="margin-top:6px;">
          Pyodide 로딩이 끝나면 업로드 가능해집니다.
        </div>
      </div>

      <div class="table-wrapper" style="margin-top:12px; display:none;" id="niceSummaryWrapPy">
        <table class="sheetlike">
          <thead>
            <tr>
              <th>종별(나이스)</th>
              <th>건수</th>
              <th>합계 일·시·분</th>
              <th>합계 시간(10진법, h)</th>
              <th>환산 (일 + 시간)</th>
            </tr>
          </thead>
          <tbody id="niceSummaryBodyPy"></tbody>
        </table>
      </div>
    </section>

    <!-- 1. Pyodide 상태 -->
    <section class="section">
      <h2>1. Pyodide 상태</h2>
      <p class="muted">
        페이지가 열리면 Pyodide가 자동 로딩되고, <code>annual_engine.py</code>를 불러옵니다.
      </p>
      <div id="pyStatus" class="status">Pyodide 로딩 중...</div>
    </section>

    <!-- 2. 입력값 -->
    <section class="section">
      <h2>2. 연차·수당 계산 입력</h2>

      <div class="card">
        <h3 style="margin-top:0;">2-1. 규정 세트 & 근속·출근 요약</h3>
        <div class="grid three">
          <div class="field">
            <label for="ruleId">규정 세트</label>
            <select id="ruleId">
              <option value="law_basic">법정 기본형 (근로기준법 단순)</option>
              <option value="gw_school_cba">학교근무자 CBA 예시</option>
              <option value="gw_institute_cba">기관근무자 CBA 예시</option>
              <option value="gw_wage_guideline">통상임금 지침형 (연차일수 외부산정)</option>
              <option value="custom">커스텀</option>
            </select>
          </div>
          <div class="field">
            <label for="serviceYears">근속연수(년, 대략)</label>
            <input id="serviceYears" type="number" step="0.1" value="1.0" class="numeric" />
          </div>
          <div class="field">
            <label for="fullYears">완전년수(정수)</label>
            <input id="fullYears" type="number" step="1" value="1" class="numeric" />
          </div>
        </div>

        <div class="grid three">
          <div class="field">
            <label for="attendanceRate">출근율(%)</label>
            <input id="attendanceRate" type="number" step="0.1" value="98.5" class="numeric" />
          </div>
          <div class="field">
            <label for="fullMonths">월 개근 개월수</label>
            <input id="fullMonths" type="number" step="1" value="12" class="numeric" />
          </div>
          <div class="field">
            <label>입사·기준일 (문자열로만 전달)</label>
            <input id="hireDate" type="text" placeholder="예: 2024-03-01" />
            <input id="baseDate" type="text" placeholder="예: 2025-03-01" style="margin-top:4px;" />
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0;">2-2. 임금 정보</h3>
        <div class="grid three">
          <div class="field">
            <label for="wageType">임금형태</label>
            <select id="wageType">
              <option value="hourly">시급</option>
              <option value="daily">일급</option>
              <option value="monthly" selected>월급</option>
            </select>
          </div>
          <div class="field">
            <label for="wageAmount">금액 (원)</label>
            <input id="wageAmount" type="number" step="10" value="2300000" class="numeric" />
          </div>
          <div class="field">
            <label for="hoursPerDay">1일 소정근로시간</label>
            <input id="hoursPerDay" type="number" step="0.5" value="8" class="numeric" />
          </div>
        </div>

        <div class="grid two">
          <div class="field">
            <label for="monthlyWorkDays">월 소정근로일수</label>
            <input id="monthlyWorkDays" type="number" step="0.1" value="20.5" class="numeric" />
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0;">2-3. 연차 부여·사용 일수</h3>
        <div class="grid two">
          <div class="field">
            <label for="grantedDays">부여 연차일수</label>
            <input id="grantedDays" type="number" step="0.5" value="26" class="numeric" />
          </div>
          <div class="field">
            <label for="usedDays">사용 연차일수</label>
            <input id="usedDays" type="number" step="0.5" value="10.5" class="numeric" />
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <button type="button" class="btn primary" id="btnRun" disabled>
          파이썬 엔진으로 연차·수당 계산
        </button>
      </div>
    </section>

    <!-- 3. 결과 -->
    <section class="section">
      <h2>3. 연차·미사용수당 계산 결과</h2>
      <div class="card">
        <div class="result-grid">
          <div class="result-item">
            <div class="result-label">규정 세트</div>
            <div class="result-value" id="resRuleName">-</div>
          </div>
          <div class="result-item">
            <div class="result-label">추천 연차일수</div>
            <div class="result-value" id="resSuggestedDays">-</div>
          </div>
          <div class="result-item">
            <div class="result-label">추천 설명</div>
            <div class="result-value" id="resSuggestedDesc" style="text-align:left;">-</div>
          </div>
          <div class="result-item">
            <div class="result-label">부여 / 사용 / 미사용 일수</div>
            <div class="result-value" id="resDaysDetail">-</div>
          </div>
          <div class="result-item">
            <div class="result-label">1일 통상임금(원단위)</div>
            <div class="result-value" id="resDailyWage">-</div>
          </div>
          <div class="result-item">
            <div class="result-label">미사용 연차수당 (계산상, 원단위)</div>
            <div class="result-value" id="resPayoutRaw">-</div>
          </div>
          <div class="result-item">
            <div class="result-label">미사용 연차수당 (절사 적용)</div>
            <div class="result-value highlight" id="resPayoutRounded">-</div>
          </div>
          <div class="result-item">
            <div class="result-label">절사 규칙</div>
            <div class="result-value" id="resRoundingRule">-</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    let pyodide = null;
    let pyReady = false;

    async function initPyodide() {
      const statusEl = document.getElementById("pyStatus");
      const niceStatus = document.getElementById("niceStatus");
      try {
        statusEl.textContent = "Pyodide 로딩 중...";
        pyodide = await loadPyodide();

        // annual_engine.py 로드
        const code = await (await fetch("annual_engine.py")).text();
        await pyodide.runPythonAsync(code);

        pyReady = true;
        statusEl.textContent = "Pyodide + annual_engine.py 로딩 완료.";
        niceStatus.textContent = "엑셀 파일을 선택한 뒤 [엑셀 업로드·집계] 버튼을 누르세요.";
        document.getElementById("btnRun").disabled = false;
        document.getElementById("btnAnalyzeNice").disabled = false;
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Pyodide 로딩 실패. 콘솔 오류 확인 필요.";
        statusEl.classList.add("danger");
        niceStatus.textContent = "Pyodide가 준비되지 않아 엑셀 집계를 할 수 없습니다.";
        niceStatus.classList.add("danger");
      }
    }

    initPyodide();

    // ---------------------------
    // 0. 나이스 엑셀 → 파이썬 summarize_nice_records
    // ---------------------------
    function guessLeaveCol(headers) {
      const cands = ["종별", "복무", "근무상태", "근태", "근무구분"];
      for (const h of headers) {
        const name = String(h || "").trim();
        if (!name) continue;
        if (cands.some(c => name.includes(c))) return name;
      }
      return null;
    }

    function guessDurCol(headers) {
      const cands = ["일수/기간", "일수", "기간"];
      for (const h of headers) {
        const name = String(h || "").trim();
        if (!name) continue;
        if (cands.some(c => name.includes(c))) return name;
      }
      return null;
    }

    document.getElementById("btnAnalyzeNice").addEventListener("click", async () => {
      if (!pyReady) {
        alert("Pyodide가 아직 준비되지 않았습니다.");
        return;
      }
      const input = document.getElementById("niceFilePy");
      const file = input.files && input.files[0];
      if (!file) {
        alert("근무상황목록 엑셀 파일을 선택해주세요.");
        return;
      }

      const hpd = parseFloat(document.getElementById("hoursPerDayPy").value || "8") || 8;
      const status = document.getElementById("niceStatus");
      status.textContent = "엑셀 파싱 중...";

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: "array" });
          const sheetName = wb.SheetNames[0];
          const ws = wb.Sheets[sheetName];
          const rows = XLSX.utils.sheet_to_json(ws, { defval: null });

          if (!rows.length) {
            alert("시트에 데이터가 없습니다.");
            status.textContent = "시트 데이터 없음.";
            return;
          }

          const headers = Object.keys(rows[0]);
          const leaveCol = guessLeaveCol(headers);
          const durCol = guessDurCol(headers);
          if (!leaveCol || !durCol) {
            alert('“종별” 또는 “일수/기간” 열을 찾지 못했습니다. 헤더명을 확인해야 합니다.');
            status.textContent = "열 자동 인식 실패.";
            return;
          }

          // JS → Pyodide 로 넘길 레코드 리스트 구성
          const records = [];
          rows.forEach(r => {
            const leave = r[leaveCol];
            if (leave === null || leave === undefined || leave === "") return;
            records.push({
              leave_type: String(leave),
              duration_raw: String(r[durCol] ?? ""),
            });
          });

          status.textContent = `레코드 ${records.length}건, 파이썬 summarize_nice_records 실행 중...`;

          // JS 배열을 파이썬으로 넘겨서 NiceRecord 리스트 생성 + summarize 호출
          const recordsPy = pyodide.toPy(records);
          pyodide.globals.set("records_js", recordsPy);
          pyodide.globals.set("hours_per_day_js", hpd);

          const pyResult = await pyodide.runPythonAsync(`
from annual_engine import NiceRecord, summarize_nice_records
py_recs = [NiceRecord(leave_type=r["leave_type"], duration_raw=r["duration_raw"], hours_per_day=hours_per_day_js)
           for r in records_js]
summarize_nice_records(py_recs)
          `);

          const result = pyResult.toJs({ deep: true });

          const tbody = document.getElementById("niceSummaryBodyPy");
          tbody.innerHTML = "";
          result.forEach(row => {
            const tr = document.createElement("tr");
            const tdType = document.createElement("td");
            const tdCount = document.createElement("td");
            const tdSum = document.createElement("td");
            const tdHours = document.createElement("td");
            const tdConv = document.createElement("td");

            tdType.textContent = row.leave_type;
            tdCount.textContent = row.count.toLocaleString("ko-KR");
            tdSum.textContent = row.sum_d_h_m;
            tdHours.textContent = row.sum_hours_decimal.toFixed(1) + " 시간";
            tdConv.textContent = row.converted_days_hours;

            tr.appendChild(tdType);
            tr.appendChild(tdCount);
            tr.appendChild(tdSum);
            tr.appendChild(tdHours);
            tr.appendChild(tdConv);
            tbody.appendChild(tr);
          });

          document.getElementById("niceSummaryWrapPy").style.display = "block";
          status.textContent = "집계 완료.";
        } catch (err) {
          console.error(err);
          alert("엑셀 집계 중 오류가 발생했습니다. 콘솔을 확인하세요.");
          status.textContent = "오류 발생.";
        }
      };
      reader.readAsArrayBuffer(file);
    });

    document.getElementById("btnResetNice").addEventListener("click", () => {
      document.getElementById("niceFilePy").value = "";
      document.getElementById("niceSummaryBodyPy").innerHTML = "";
      document.getElementById("niceSummaryWrapPy").style.display = "none";
      document.getElementById("niceStatus").textContent =
        pyReady ? "엑셀 파일을 선택한 뒤 [엑셀 업로드·집계] 버튼을 누르세요." :
                  "Pyodide가 준비되면 업로드 가능해집니다.";
    });

    // ---------------------------
    // 2. full_pipeline 호출 (연차·수당)
    // ---------------------------
    document.getElementById("btnRun").addEventListener("click", async () => {
      if (!pyReady) {
        alert("Pyodide가 아직 준비되지 않았습니다.");
        return;
      }

      const ruleId = document.getElementById("ruleId").value;

      const serviceDict = {
        hire_date: document.getElementById("hireDate").value || "",
        base_date: document.getElementById("baseDate").value || "",
        service_years: parseFloat(document.getElementById("serviceYears").value || "0"),
        full_years: parseInt(document.getElementById("fullYears").value || "0"),
        attendance_rate: parseFloat(document.getElementById("attendanceRate").value || "0"),
        full_months: parseInt(document.getElementById("fullMonths").value || "0"),
      };

      const wageDict = {
        wage_type: document.getElementById("wageType").value,
        wage_amount: parseFloat(document.getElementById("wageAmount").value || "0"),
        hours_per_day: parseFloat(document.getElementById("hoursPerDay").value || "0"),
        monthly_work_days: parseFloat(document.getElementById("monthlyWorkDays").value || "0"),
      };

      const granted = parseFloat(document.getElementById("grantedDays").value || "0");
      const used = parseFloat(document.getElementById("usedDays").value || "0");

      try {
        const svcPy = pyodide.toPy(serviceDict);
        const wagePy = pyodide.toPy(wageDict);
        pyodide.globals.set("svc_js", svcPy);
        pyodide.globals.set("wage_js", wagePy);

        const result = await pyodide.runPythonAsync(`
from annual_engine import full_pipeline
full_pipeline("${ruleId}", svc_js, wage_js, ${granted}, ${used})
        `);

        const res = result.toJs({ deep: true });

        document.getElementById("resRuleName").textContent = res.rule.name || "-";

        const sug = res.suggestion || {};
        document.getElementById("resSuggestedDays").textContent =
          (sug.suggested_days === null || sug.suggested_days === undefined)
            ? "직접 입력 필요"
            : sug.suggested_days.toString() + " 일";
        document.getElementById("resSuggestedDesc").textContent = sug.description || "-";

        const pay = res.payout || {};
        document.getElementById("resDaysDetail").textContent =
          `부여 ${pay.granted_days ?? 0}일 / 사용 ${pay.used_days ?? 0}일 / 미사용 ${pay.unused_days ?? 0}일`;

        document.getElementById("resDailyWage").textContent =
          pay.daily_wage_raw ? Math.round(pay.daily_wage_raw).toLocaleString("ko-KR") + " 원" : "-";

        document.getElementById("resPayoutRaw").textContent =
          pay.payout_raw ? Math.round(pay.payout_raw).toLocaleString("ko-KR") + " 원" : "-";

        document.getElementById("resPayoutRounded").textContent =
          pay.payout_rounded ? Math.round(pay.payout_rounded).toLocaleString("ko-KR") + " 원" : "-";

        document.getElementById("resRoundingRule").textContent =
          `${pay.rounding_step ?? 10}원 단위 ${pay.rounding_mode || "floor"} (1원 절삭)`;
      } catch (e) {
        console.error(e);
        alert("파이썬 엔진 실행 중 오류가 발생했습니다. 콘솔을 확인하세요.");
      }
    });
  </script>
</body>
</html>
