<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>관내여비 자동 검증기 (Pyodide 버전)</title>

  <!-- 공통 스타일: 네 사이트 기준 -->
  <link rel="stylesheet" href="/static/style.css" />

  <!-- Pyodide 로더 -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>

  <style>
    /* 이 페이지용 보조 스타일만 약간 추가 */
    .page-wrap {
      max-width: 880px;
      margin: 0 auto;
      padding: 24px 16px 32px;
    }
    .file-area {
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 16px 18px;
      background: #fff;
      margin: 18px 0;
    }
    .file-area p {
      margin: 8px 0;
    }
    .log-box {
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      padding: 10px 12px;
      background: #fafafa;
      font-size: 0.95rem;
      white-space: pre-wrap;
      margin-top: 8px;
      max-height: 180px;
      overflow: auto;
    }
    .result-box {
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      padding: 10px 12px;
      background: #fafafa;
      margin: 12px 0;
    }
    .result-box h3 {
      margin-top: 0;
    }
    .result-box textarea {
      width: 100%;
      min-height: 180px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
      border-radius: 8px;
      border: 1px solid #d4d4d8;
      padding: 8px 10px;
      background: #f9fafb;
      resize: vertical;
      white-space: pre;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      font-size: 0.8rem;
      border-radius: 999px;
      background: #eef2ff;
      color: #1f2937;
      border: 1px solid #c7d2fe;
    }
  </style>
</head>
<body>
  <!-- 상단 메인으로 돌아가기 -->
  <div class="home-link-wrap">
    <a href="/" class="btn-home">← 메인으로 돌아가기</a>
  </div>

  <header class="site-header">
    <div class="shell">
      <h1>관내여비 자동 검증기 (브라우저 Pyodide)</h1>
      <p class="sub">
        · 나이스 관내여비 지급내역 엑셀(.xlsx) 여러 개를 업로드하면, 브라우저 안에서 파이썬(pandas)로 월별 요약·이상행을 자동 검증합니다.<br />
        · 서버가 필요 없어서 GitHub Pages 같은 정적 페이지에서도 동작합니다.
      </p>
    </div>
  </header>

  <main class="page-wrap">
    <section class="section">
      <h2 class="local-h2">1. 사용 전제 (엑셀 구조)</h2>
      <ul>
        <li>엑셀 헤더(1행)에 다음 열이 있어야 합니다: <strong>시작일, 출장자, 부지급, 지급금액</strong></li>
        <li><strong>부지급 = "아니오"</strong> 인 행만 실제 지급으로 간주합니다.</li>
        <li>관내 단가는 <strong>10,000 / 20,000원</strong>만 정상 단위금액으로 보고, 그 외 금액은 이상행으로 플래그합니다.</li>
        <li>여러 연도·월 파일(.xlsx)을 한 번에 선택하면, 월별(연월) 기준으로 모두 합산해서 검증합니다.</li>
      </ul>
      <p class="local-small muted">
        ※ 실제 감사·지급 시에는 여비 규정, 교육청 지침, 출장명령서·여비명세서 등과 함께 최종 판단해야 합니다.
      </p>
    </section>

    <section class="section file-area">
      <h2 class="local-h2">2. 엑셀 업로드 및 검증 실행</h2>

      <p>
        <span class="badge">관내여비 관점 자동 검증</span>
      </p>
      <p class="local-small muted">
        · 3년치 관내여비 지급내역 엑셀(.xlsx)을 모두 선택해서 업로드하면, 월별 요약과 이상행 목록을 한 번에 생성합니다.<br />
        · 파일 선택 후 <strong>“검증 실행”</strong> 버튼을 눌러주세요.
      </p>

      <div class="row" style="margin-top:10px;">
        <input type="file" id="fileInput" accept=".xlsx" multiple />
        <button type="button" class="btn primary" id="runAuditBtn">검증 실행</button>
      </div>

      <div id="pyLog" class="log-box">
        Pyodide 로딩 대기 중입니다...
      </div>
    </section>

    <section class="section">
      <h2 class="local-h2">3. 결과 (CSV 형식)</h2>

      <div class="result-box">
        <h3 class="local-h3">3-1. 월별 관내여비 요약 (inner_monthly_summary.csv)</h3>
        <p class="local-small muted">
          · 연월별 관내여비 총액/건수/이상행 건수/최소·최대금액 및 “전건 허용 단위금액 여부”가 정리됩니다.
        </p>
        <textarea id="summaryOutput" readonly placeholder="여기에 월별 요약 CSV 결과가 표시됩니다."></textarea>
      </div>

      <div class="result-box">
        <h3 class="local-h3">3-2. 관내여비 이상행 상세 (inner_detail_flags.csv)</h3>
        <p class="local-small muted">
          · 10,000 / 20,000원이 아닌 지급액이 표시되며, 연월/지급일자/성명/지급액/파일명·시트명이 함께 출력됩니다.
        </p>
        <textarea id="detailOutput" readonly placeholder="여기에 이상행 상세 CSV 결과가 표시됩니다."></textarea>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="shell">
      <p>관내여비 자동 검증기 (Pyodide / pandas 기반)</p>
      <p class="muted">
        · 서버 없이 브라우저에서만 동작하는 시범 버전입니다. 대용량 파일이 많을 경우 브라우저 성능에 영향을 줄 수 있습니다.
      </p>
    </div>
  </footer>

  <script>
    // ============================
    // 1. Pyodide 로딩
    // ============================

    let pyodideReadyPromise = null;

    async function initPyodideAndPackages() {
      const logEl = document.getElementById("pyLog");
      logEl.textContent = "Pyodide 로딩 중... (최초 1회만 다소 시간이 걸릴 수 있습니다)";

      // Pyodide 로드
      const pyodide = await loadPyodide();

      logEl.textContent = "pandas 패키지 로딩 중...";

      // pyodide에는 pandas가 기본 포함되어 있음
      await pyodide.loadPackage("pandas");

      // 여기서 Python 쪽 검증 함수 정의
      const pythonCode = `
import io
import pandas as pd
from datetime import datetime

# ===== 환경 설정 =====
DATE_COL = "시작일"      # 날짜
NAME_COL = "출장자"      # 성명
AMOUNT_COL = "지급금액"   # 금액
FLAG_COL = "부지급"      # 부지급 여부 (아니오만 사용)
ALLOWED_AMOUNTS = {10000, 20000}

def normalize_date_series(s):
    \"\"\"날짜 열을 datetime으로 통일\"\"\"
    return pd.to_datetime(s, errors="coerce")

def audit_inner_travel(file_list):
    \"\"\"
    file_list: 브라우저에서 업로드한 엑셀 파일 경로 리스트 (Pyodide FS 상 경로)
    반환값: (summary_csv_str, detail_csv_str)
    \"\"\"
    frames = []
    for path in file_list:
        try:
            # sheet_name=None 이면 모든 시트를 dict로 읽어옴
            xls = pd.read_excel(path, sheet_name=None)
            for sheet_name, df in xls.items():
                if df is None or df.empty:
                    continue
                tmp = df.copy()
                tmp["__파일명"] = path
                tmp["__시트명"] = sheet_name
                frames.append(tmp)
        except Exception as e:
            # 읽기 실패해도 전체는 계속 진행
            print(f"[경고] 파일 읽기 실패: {path} -> {e}")

    if not frames:
        raise ValueError("엑셀에서 읽어온 시트가 없습니다. 파일 구조를 확인하세요.")

    df_all = pd.concat(frames, ignore_index=True)

    # 필수 열 체크
    required_cols = [DATE_COL, NAME_COL, AMOUNT_COL, FLAG_COL]
    missing = [c for c in required_cols if c not in df_all.columns]
    if missing:
        raise ValueError(f"다음 열을 찾을 수 없습니다. 엑셀 헤더 또는 설정을 확인하세요: {missing}")

    # 부지급 != "아니오" 는 제외 (실제 지급만 사용)
    df = df_all[df_all[FLAG_COL].astype(str).str.strip() == "아니오"].copy()
    if df.empty:
        raise ValueError("부지급='아니오' 인 행이 없습니다. 엑셀 구조 또는 필터 조건을 확인하세요.")

    # 날짜·연월 정리
    df["__날짜"] = normalize_date_series(df[DATE_COL])
    df["연월"] = df["__날짜"].dt.to_period("M").astype(str)

    # 금액·성명 정리
    df["__지급액"] = pd.to_numeric(df[AMOUNT_COL], errors="coerce").fillna(0).astype(int)
    df["__성명"] = df[NAME_COL].astype(str).fillna("")

    # 허용 단위금액 여부
    df["허용단위금액여부"] = df["__지급액"].isin(ALLOWED_AMOUNTS)
    # 만원 단위 여부
    df["만원단위여부"] = (df["__지급액"] % 10000 == 0)
    # 이상행: 허용 단위금액이 아님
    df["이상여부"] = ~df["허용단위금액여부"]

    # ===== 1) 월별 요약 =====
    grouped = df.groupby("연월")
    summary = grouped.agg(
        관내여비_총액=("__지급액", "sum"),
        지급건수=("__지급액", "size"),
        허용단위금액_건수=("허용단위금액여부", "sum"),
        이상행_건수=("이상여부", "sum"),
        최소금액=("__지급액", "min"),
        최대금액=("__지급액", "max"),
        파일수=("__파일명", "nunique"),
    ).reset_index()

    summary["전건_허용단위금액"] = summary["지급건수"] == summary["허용단위금액_건수"]

    # ===== 2) 이상행 상세 =====
    detail = df[df["이상여부"]].copy()
    keep_cols = [
        "연월",
        "__날짜",
        "__성명",
        "__지급액",
        "__파일명",
        "__시트명",
        "허용단위금액여부",
        "만원단위여부",
    ]
    detail = detail[keep_cols].rename(
        columns={
            "__날짜": "지급일자",
            "__성명": "성명",
            "__지급액": "지급액",
        }
    )

    # CSV 문자열로 변환 (UTF-8, BOM 없이)
    summary_csv = summary.to_csv(index=False)
    detail_csv = detail.to_csv(index=False)

    return summary_csv, detail_csv
      `;

      pyodide.runPython(pythonCode);
      logEl.textContent = "Pyodide + pandas 로딩 완료. 엑셀 파일을 선택한 후 '검증 실행' 버튼을 눌러 주세요.";
      return pyodide;
    }

    // 최초 1회 로딩
    pyodideReadyPromise = initPyodideAndPackages();

    // ============================
    // 2. 파일을 Pyodide FS로 넘겨서 검증 실행
    // ============================

    async function runAudit() {
      const logEl = document.getElementById("pyLog");
      const summaryOutput = document.getElementById("summaryOutput");
      const detailOutput = document.getElementById("detailOutput");

      summaryOutput.value = "";
      detailOutput.value = "";

      const fileInput = document.getElementById("fileInput");
      const files = fileInput.files;
      if (!files || files.length === 0) {
        alert("관내여비 지급내역 엑셀(.xlsx) 파일을 하나 이상 선택해 주세요.");
        return;
      }

      logEl.textContent = `Pyodide 준비 상태 확인 중...`;
      const pyodide = await pyodideReadyPromise;

      // 업로드용 폴더 생성 (이미 있으면 무시)
      try {
        pyodide.FS.mkdir("uploads");
      } catch (e) {
        // 이미 있으면 오류 무시
      }

      logEl.textContent = `엑셀 파일 ${files.length}개를 브라우저로 읽는 중...`;

      // JS에서 ArrayBuffer -> Pyodide FS 로 쓰기
      const filePaths = [];
      for (const file of files) {
        const arrayBuffer = await file.arrayBuffer();
        const uint8Array = new Uint8Array(arrayBuffer);
        const safeName = "uploads/" + file.name.replace(/[^a-zA-Z0-9._-]/g, "_");
        pyodide.FS.writeFile(safeName, uint8Array);
        filePaths.push(safeName);
      }

      logEl.textContent =
        `엑셀 ${files.length}개를 FS에 저장 완료. 파이썬으로 검증을 실행합니다...`;

      try {
        // Python 쪽 audit_inner_travel(file_list) 호출
        const fileListLiteral = JSON.stringify(filePaths);
        const code = `
file_list = ${fileListLiteral}
summary_csv, detail_csv = audit_inner_travel(file_list)
`;
        await pyodide.runPythonAsync(code);

        const summary_csv = pyodide.globals.get("summary_csv");
        const detail_csv = pyodide.globals.get("detail_csv");

        summaryOutput.value = summary_csv.toString();
        detailOutput.value = detail_csv.toString();

        logEl.textContent =
          "검증 완료. 아래 월별 요약과 이상행 CSV를 확인해 주세요. 필요시 복사해서 엑셀에 붙여넣으면 됩니다.";
      } catch (err) {
        console.error(err);
        logEl.textContent =
          "검증 중 오류가 발생했습니다. 엑셀 헤더(시작일/출장자/부지급/지급금액)와 내용 구조를 다시 확인해 주세요.\n\n" +
          String(err);
      }
    }

    document.getElementById("runAuditBtn").addEventListener("click", () => {
      runAudit();
    });
  </script>
</body>
</html>
